
--NAIHATI LOAN DATA MIGRATION ON 14/08/2020
---------------------------------------------------------------------

create table njml_pfloan_jul20 as
select * from njml_pfloan_jun20_new
where 1=2

select * from njml_pfloan_jul20

delete from njml_pfloan_jul20
where tokenno is null

--KEEP BACKUP TABLES

CREATE TABLE PFLOANTRANSACTION_BK_03 AS
SELECT * FROM PFLOANTRANSACTION

CREATE TABLE PFLOANAPPLICATION_BK_03 AS
SELECT * FROM PFLOANAPPLICATION

CREATE TABLE PFLOANBREAKUP_BK_03 AS
SELECT * FROM PFLOANBREAKUP

CREATE TABLE PFLOANINTEREST_BK_03 AS
SELECT * FROM PFLOANINTEREST 

-------------------------------------------------------------------------------


EXEC PROC_PFLOANBLNC('NJ0002','0010','15/07/2020','15/07/2020','MPL','')

SELECT * FROM GBL_PFLOANBLNC
 

-----------------------------------------------------------
SELECT * FROM PFLOANTRANSACTION

-----------------------------------------------------------
--INSERT SCRIPT FOR LOANTRANSACTION
-----------------------------------------------------------
--Insert into NJMCL_WEB.PFLOANAPPLICATION
Insert into NJMCL_WEB.PFLOANTRANSACTION
   (COMPANYCODE, DIVISIONCODE, EMPLOYEECOMPANYCODE, EMPLOYEEDIVISIONCODE, YEARCODE, 
    YEARMONTH, CATEGORYCODE, GRADECODE, PFNO, WORKERSERIAL, 
    TOKENNO, LOANCODE, LOANDATE, LOANTYPE, AMOUNT, 
    INTERESTPERCENTAGE, NOOFINSTALLMENTS, AGAINSTCOMPONENT, OPENINGBALANCE, RATIOPERCENT, 
    COMPONENTAMOUNT, CLOSINGBALANCE, ACTUALLOANAMOUNT, ACTUALLOANDATE, COMMITEDRECOVERYPERIOD, 
    LOANCLAIMAMOUNT, INTERESTDEDNMONTHLY, LOANAMOUNTADJUSTED, LOANINTAMOUNTADJUSTED, AGAINSTLOANDATE, 
    AGAINSTLOANCODE, PAYABLEAMOUNT, APPLICATIONNO, AMOUNTINHAND, INTERESTAMOUNT, 
    CAPITALINSTALLMENTAMT, INTERESTINSTALLMENTAMT, REPAYCAPITAL, REPAYINTEREST, ADJUSTMENTDATE, 
    REMARKS, DEPARTMENTCODE, FORTNIGHTSTARTDATE, LOANNL, NEXTLOAN, 
    ACTUALINTERESTAMOUNT, NEWINTERESTAMOUNT, DEDUCTIONSTARTDATE, INTERESTBALANCEAMOUNT, CAPITALBALANCEAMOUNT, 
    CAPITALINSTALLMENTAMOUNT, INTERESTINSTALLMENTAMOUNT, ADJUSTEDLOANDATE, TOTALEMIAMOUNT, PF_E, 
    PF_C, VPF, MINBALANCE, ACTUALBALANCE, MODULE, 
    PFGROSS, VOUCHERNO, VOUCHERDATE, SYSTEMVOUCHERNO, SYSTEMVOUCHERDATE, 
    CHEQUENO, CHEQUEDATE, ELIGIBLE, LASTMODIFIED, USERNAME, 
    SYSROWID, LOANCF, SANCTIONEDAMOUNT, PREV_LOAN_CAP_EMI, PREV_LOAN_INT_EMI, 
    CURR_INT_EMI, CURR_CAP_EMI)
SELECT B.COMPANYCODE, B.DIVISIONCODE, CURRENTCOMPANYCODE, CURRENTDIVISIONCODE,'2020-2021' YEARCODE, 
    '202007' YEARMONTH, CATEGORYCODE, GRADECODE, A.PFNO, B.WORKERSERIAL, 
    A.TOKENNO, A.LOAN_CODE E,TO_DATE(A.LOAN_DATE,'DD/MM/YYYY') LOANDATE,REFUNDTYPE LOANTYPE,NEW_LV_CAP_AMT AMOUNT, 
    INTERESTPERCENTAGE,NO_OF_YEARS*25 NOOFINSTALLMENTS,NULL AGAINSTCOMPONENT,NULL OPENINGBALANCE,NULL RATIOPERCENT, 
    NULL COMPONENTAMOUNT,NULL CLOSINGBALANCE,NEW_LV_CAP_AMT ACTUALLOANAMOUNT,TO_DATE(A.LOAN_DATE,'DD-MM-YYYY') ACTUALLOANDATE, 
    13 COMMITEDRECOVERYPERIOD, LN_AMOUNT LOANCLAIMAMOUNT,NULL INTERESTDEDNMONTHLY,
    PREV_LN_CAP_BAL LOANAMOUNTADJUSTED,PREV_LN_INT_BAL LOANINTAMOUNTADJUSTED,D.LOANDATE AGAINSTLOANDATE, 
    D.LOANCODE AGAINSTLOANCODE,LN_AMOUNT PAYABLEAMOUNT,'XXXXX' APPLICATIONNO,LN_AMOUNT AMOUNTINHAND,A.INT_AMT INTERESTAMOUNT, 
    NEW_CAP_EMI CAPITALINSTALLMENTAMT,NEW_INT_EMI INTERESTINSTALLMENTAMT,NULL REPAYCAPITAL,NULL REPAYINTEREST,NULL ADJUSTMENTDATE, 
    'INSERT DATA FROM SCRIPT ON 14/08/2020' REMARKS, DEPARTMENTCODE,TO_DATE(FN_GETFORTNIGHTSTARTENDDATE(A.LOAN_DATE,'START'),'DD/MM/YYYY') FORTNIGHTSTARTDATE,NULL LOANNL,NULL NEXTLOAN, 
    NULL ACTUALINTERESTAMOUNT,NULL NEWINTERESTAMOUNT,'16-JUN-2020' DEDUCTIONSTARTDATE,NULL INTERESTBALANCEAMOUNT,NULL CAPITALBALANCEAMOUNT, 
    NEW_CAP_EMI CAPITALINSTALLMENTAMOUNT,NEW_INT_EMI INTERESTINSTALLMENTAMOUNT,NULL ADJUSTEDLOANDATE,NEW_CAP_EMI TOTALEMIAMOUNT,NULL PF_E, 
    NULL PF_C,NULL VPF,NULL MINBALANCE,NULL ACTUALBALANCE,'WPS' MODULE, 
    NULL PFGROSS,NULL VOUCHERNO,NULL VOUCHERDATE,NULL  SYSTEMVOUCHERNO,NULL  SYSTEMVOUCHERDATE, 
    NULL CHEQUENO,NULL  CHEQUEDATE,NULL  ELIGIBLE,SYSDATE LASTMODIFIED,'SWT' USERNAME, 
    SYS_GUID() SYSROWID, LOANCF,LN_AMOUNT SANCTIONEDAMOUNT,PREV_CAP_EMI PREV_LOAN_CAP_EMI,PREV_INT_EMI PREV_LOAN_INT_EMI, 
    A.INT_EMI CURR_INT_EMI,A.CAP_EMI CURR_CAP_EMI
    FROM NJML_PFLOAN_JUL20 A, PFEMPLOYEEMASTER B, PFLOANMASTER C, GBL_PFLOANBLNC D
WHERE A.TOKENNO=B.TOKENNO
AND A.LN_AMOUNT > 0
AND A.LOAN_CODE=C.LOANCODE
AND A.TOKENNO=D.TOKENNO(+)

-----------------------------------------------------------
SELECT * FROM PFLOANAPPLICATION

-----------------------------------------------------------
-----------------------------------------------------------
SELECT * FROM PFLOANBREAKUP

-----------------------------------------------------------
-- INSERT SCRIPT FOR PF LOAN BREAKUP
-----------------------------------------------------------

Insert into NJMCL_WEB.PFLOANBREAKUP
   (COMPANYCODE, DIVISIONCODE, EMPLOYEECOMPANYCODE, EMPLOYEEDIVISIONCODE, YEARCODE, 
    YEARMONTH, CATEGORYCODE, GRADECODE, PFNO, TOKENNO, 
    WORKERSERIAL, LOANCODE, LOANDATE, EFFECTYEARMONTH, INTERESTPERCENTAGE, 
    AMOUNT, TRANSACTIONTYPE, EFFECTFORTNIGHT, PAIDON, ISPAID, 
    DEDUCTEDAMT, ADJUSTMENTTAG, REMARKS, REPAYAMOUNT, REPAYCAPITAL, 
    REPAYINTEREST, REPAYREBATE, FINALSETTLEMENTTAG, REPAYDATE, MODULE, 
    DELETERESION, VOUCHERNO, VOUCHERDATE, SYSTEMVOUCHERNO, SYSTEMVOUCHERDATE, 
    CHEQUENO, CHEQUEDATE, SYSROWID, USERNAME, LASTMODIFIED, 
    ISCASHREPAYMENT, DEDUCTFROM)
SELECT B.COMPANYCODE, B.DIVISIONCODE, CURRENTCOMPANYCODE, CURRENTDIVISIONCODE,'2020-2021' YEARCODE, 
    '202007' YEARMONTH, CATEGORYCODE, GRADECODE, A.PFNO, A.TOKENNO, 
    B.WORKERSERIAL,D.LOANCODE LOANCODE,D.LOANDATE LOANDATE,'202007' EFFECTYEARMONTH,C.INTERESTPERCENTAGE, 
    NEW_LV_CAP_AMT AMOUNT,'REPAY' TRANSACTIONTYPE,TO_DATE(A.LOAN_DATE,'DD/MM/YYYY') EFFECTFORTNIGHT,TO_DATE(A.LOAN_DATE,'DD/MM/YYYY') PAIDON,'Y' ISPAID, 
    NULL DEDUCTEDAMT,'REPAY' ADJUSTMENTTAG,'INSERT DATA FROM SCRIPT ON 14/08/2020' REMARKS,PREV_LN_CAP_BAL REPAYAMOUNT,PREV_LN_CAP_BAL REPAYCAPITAL, 
    PREV_LN_INT_BAL REPAYINTEREST,NULL REPAYREBATE,NULL FINALSETTLEMENTTAG,TO_DATE(A.LOAN_DATE,'DD/MM/YYYY') REPAYDATE,'WPS' MODULE, 
    NULL DELETERESION,NULL VOUCHERNO,NULL VOUCHERDATE,NULL SYSTEMVOUCHERNO,NULL SYSTEMVOUCHERDATE, 
    NULL CHEQUENO,NULL CHEQUEDATE,SYS_GUID() SYSROWID,'SWT' USERNAME,SYSDATE LASTMODIFIED, 
    NULL ISCASHREPAYMENT,'REPAY' DEDUCTFROM 
    FROM NJML_PFLOAN_JUL20 A, PFEMPLOYEEMASTER B, PFLOANMASTER C, GBL_PFLOANBLNC D
WHERE A.TOKENNO=B.TOKENNO
AND A.LN_AMOUNT > 0
AND A.LOAN_CODE=C.LOANCODE
AND A.TOKENNO=D.TOKENNO



-----------------------------------------------------------
SELECT * FROM PFLOANINTEREST 

-----------------------------------------------------------
--LOAN INTEREST SCRIPT
-----------------------------------------------------------
Insert into NJMCL_WEB.PFLOANINTEREST
   (COMPANYCODE, DIVISIONCODE, YEARCODE, YEARMONTH, FORTNIGHTSTARTDATE, 
    FORTNIGHTENDDATE, PFNO, LOANCODE, LOANDATE, LOANAMOUNT, 
    INTERESTAPPLICABLEON, INTERESTPERCENTAGE, INTERESTAMOUNT, EMPLOYEECOMPANYCODE, EMPLOYEEDIVISIONCODE, 
    MODULE, TRANSACTIONTYPE, REMARKS, USERNAME, SYSROWID, 
    WORKERSERIAL, TOKENNO)

SELECT B.COMPANYCODE, B.DIVISIONCODE,'2020-2021' YEARCODE,'202007' YEARMONTH, 
    TO_DATE(FN_GETFORTNIGHTSTARTENDDATE(A.LOAN_DATE,'START'),'DD/MM/YYYY')  FORTNIGHTSTARTDATE, 
    TO_DATE(FN_GETFORTNIGHTSTARTENDDATE(A.LOAN_DATE,'END'),'DD/MM/YYYY')  FORTNIGHTENDDATE, B.PFNO, A.LOAN_CODE LOANCODE,
    TO_DATE(A.LOAN_DATE,'DD/MM/YYYY') LOANDATE,NEW_LV_CAP_AMT LOANAMOUNT, 
    NEW_LV_CAP_AMT INTERESTAPPLICABLEON, INTERESTPERCENTAGE,A.NEW_LN_INT_AMT INTERESTAMOUNT,  CURRENTCOMPANYCODE, CURRENTDIVISIONCODE, 
    'WPS' MODULE,'ADD' TRANSACTIONTYPE,'INSERT DATA FROM SCRIPT ON 14/08/2020' REMARKS,'SWT' USERNAME,SYS_GUID() SYSROWID, 
    B.WORKERSERIAL, A.TOKENNO
    FROM NJML_PFLOAN_JUL20 A, PFEMPLOYEEMASTER B, PFLOANMASTER C, GBL_PFLOANBLNC D
WHERE A.TOKENNO=B.TOKENNO
AND A.LN_AMOUNT > 0
AND A.LOAN_CODE=C.LOANCODE
AND A.TOKENNO=D.TOKENNO(+)

---------------------------------------------------------------------------------------------

SELECT * FROM NJML_PFLOAN_JUL20

SELECT * FROM GBL_PFLOANBLNC

SELECT A.TOKENNO, A.PFNO, B.LOAN_CODE, PFLOAN_BAL,A.PFLOAN_INT_BAL, A.CAP_EMI, A.INT_EMI, --A.TOT_EMI,
B.PREV_LN_CAP_BAL,B.PREV_LN_INT_BAL,B.PREV_CAP_EMI,B.PREV_INT_EMI,B.NEW_LV_CAP_AMT, B.NEW_LN_INT_AMT, B.NEW_CAP_EMI, B.NEW_INT_EMI
FROM GBL_PFLOANBLNC A, NJML_PFLOAN_JUL20 B
WHERE A.PFNO=B.PFNO
AND A.LOANCODE=B.LOAN_CODE
AND A.PFLOAN_BAL <> B.PREV_LN_CAP_BAL

SELECT * FROM PFLOANTRANSACTION
WHERE LOANDATE='15-JUL-2020' 

SELECT * FROM PFLOANINTEREST
WHERE LOANDATE='15-JUN-2020' 

UPDATE PFLOANINTEREST
SET LOANDATE='15-JUL-2020' 
WHERE LOANDATE='15-JUN-2020' 




---------------------------------------------------------------------------------------------

