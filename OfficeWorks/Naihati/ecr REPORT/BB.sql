 INSERT INTO GTT_PFCONTRIBUTION 
     (COMPANYCODE, COMPANYNAME, DIVISIONCODE, DIVISIONNAME, YEARCODE, WORKERTYPE, EMPLOYEECODE, EMPLOYEEPFACCNUMBER, PEN,
     CATEGORYCODE, GRADECODE, PFGROSS, PF_LOAN_CAPITAL, PF_E, PF_C, VPF, PENSIONNO,UANNO,GROSSWAGES,EX2, EMPLOYEENAME, 
     DEPARTMENTCODE, WORKINGDAYS, WITHOUTPAYDAYS, REPORTHEADER, PRINTDATE, EX1,EX3)          

   SELECT COMPANYCODE,'THE NAIHATI JUTE MILLS  COMPANY LTD.' COMPANYNAME, DIVISIONCODE,'MILL' DIVISIONNAME,YEARCODE,WORKERTYPE, 
   WORKERCODE EMPLOYEECODE,PFNO EMPLOYEEPFACCNUMBER,SUM(PEN) PEN, CATEGORYCODE,GRADECODE,SUM(PFGROSS) PFGROSS,  
 SUM(PF_LOAN_CAPITAL) PF_LOAN_CAPITAL,SUM(PF_E) PF_E, SUM(PF_C) PF_C, SUM(VPF) VPF, PENSIONNO, UANNO,GROSSEARN,PEN_GROSS, 
 WORKERNAME EMPLOYEENAME, DEPARTMENTCODE, SUM(WORKINGDAYS) WORKINGDAYS, 
 CASE WHEN SUM(WORKINGDAYS) >= LV_LASTDAY THEN 0 ELSE LV_LASTDAY - SUM(WORKINGDAYS) END
 SUM(WITHOUTPAYDAYS) WITHOUTPAYDAYS,  
 'Monthly PF & FPF Contribution for the Month  : NOV-20' REPORTHEADER, TO_CHAR(SYSDATE,'DD/MM/YYYY') PRINTDATE,  
 CASE WHEN SUM(NVL(PFGROSS,0))>15000 THEN 15000 ELSE SUM(NVL(PFGROSS,0)) END EX1, TO_CHAR(LAST_DAY(TO_DATE('NOV-20','MON-YY')),'DD/MM/YYYY') LASTDAY
 FROM  
 (  
 SELECT A.COMPANYCODE,A.DIVISIONCODE,A.YEARCODE,WORKERCODE,B.PFNO,PEN,CATEGORYCODE,GRADECODE,A.MODULE WORKERTYPE,  
 CASE WHEN SUM(NVL(PFGROSS,0))>15000 AND A.MODULE='WPS' THEN 15000 ELSE SUM(NVL(PFGROSS,0)) END PFGROSS,  
 C.PF_LOAN_CAPITAL,PF_E,  PF_C,  VPF, B.PENSIONNO,B.UANNO,GROSSEARN,PEN_GROSS, B.WORKERNAME, B.DEPARTMENTCODE,WORKINGDAYS, WITHOUTPAYDAYS,TOTALEARNING 
 FROM VW_PFSUMM_DATA_TEMP A, VW_WPSPISMASTER B,   
 (  
 SELECT PFNO, SUM(AMOUNT) PF_LOAN_CAPITAL  
 FROM PFLOANBREAKUP  
  WHERE --COMPANYCODE = 'NJ0001' AND DIVISIONCODE = '0002'  
  TO_NUMBER(TO_CHAR(PAIDON,'YYYYMM')) >= TO_NUMBER(TO_CHAR(TO_DATE('NOV-20','MON-YY'),'YYYYMM'))  
 AND TO_NUMBER(TO_CHAR(PAIDON,'YYYYMM')) <= TO_NUMBER(TO_CHAR(TO_DATE('NOV-20','MON-YY'),'YYYYMM'))  
 AND TRANSACTIONTYPE ='CAPITAL'  
 AND YEARCODE='2020-2021'  
 GROUP BY PFNO  
 )  C  
 WHERE TO_NUMBER(A.YEARMONTH) >= TO_NUMBER(TO_CHAR(TO_DATE('NOV-20','MON-YY'),'YYYYMM'))  
   AND TO_NUMBER(A.YEARMONTH) <= TO_NUMBER(TO_CHAR(TO_DATE('NOV-20','MON-YY'),'YYYYMM'))  
 AND A.COMPANYCODE='NJ0001'  
 AND A.YEARCODE='2020-2021' 
 AND A.COMPANYCODE=B.COMPANYCODE  
 AND A.DIVISIONCODE=B.DIVISIONCODE  
 AND A.MODULE=B.WORKERTYPE  
 AND A.pfno=B.pfno --A.WORKERSERIAL=B.WORKERSERIAL  
 AND A.PF_E>0  
 AND B.PFNO = C.PFNO (+)  
 GROUP BY A.COMPANYCODE,A.DIVISIONCODE,A.YEARCODE,WORKERCODE,B.PFNO,PEN, CATEGORYCODE,GRADECODE,A.MODULE, C.PF_LOAN_CAPITAL,PF_E,PF_C,  
 VPF,PENSIONNO, UANNO,GROSSEARN,PEN_GROSS,WORKERNAME , DEPARTMENTCODE,WORKINGDAYS, WITHOUTPAYDAYS,TOTALEARNING  
 )  
 GROUP BY COMPANYCODE,DIVISIONCODE,YEARCODE,WORKERTYPE,WORKERCODE ,PFNO , CATEGORYCODE,GRADECODE, WORKERNAME , DEPARTMENTCODE,TOTALEARNING,PENSIONNO,UANNO,GROSSEARN,PEN_GROSS  
 ORDER BY WORKERCODE