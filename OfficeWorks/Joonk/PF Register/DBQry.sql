SELECT CATEGORYCODE,sum(PF_GROSS) ,SUM(PF_E),SUM(PF_C),SUM(FPF) ,SUM(PF_E)-SUM(FPF) EPF FROM GPSPAYSHEETDETAILS
WHERE PERIODTO >=TO_DATE('01/08/2020','DD/MM/YYYY') 
AND PERIODTO <=TO_DATE('31/08/2020','DD/MM/YYYY') 
AND DIVISIONCODE ='0007' 
AND COMPANYCODE ='JT0069'
AND CLUSTERCODE  IN ('KO')
AND PF_E>0 
AND CATEGORYCODE IN ('SU','PE') 
group by CATEGORYCODE


-------------------------------------------------------------

--exec PROC_RPT_GPSPFREGISTER('JT0069','0007','01/08/2020','31/08/2020','','''KO''')

exec PROC_RPT_GPSPFREGISTER('JT0069','0007','01/08/2020','31/08/2020','''ST''','')

-------------

EXEC PROC_RPT_PFUPLOAD('JT0069','0007','202008','')

SELECT * FROM GTT_RPT_PFUPLOAD



------------------------------------------------------------------

INSERT INTO GTT_GPSPFREGISTER
          
          
          SELECT COMPANYNAME, DIVISIONNAME, CATEGORYCODE, CATEGORYDESC,  GROSSWAGES, EPF, PF_GROSS1, PF_TMP, PF_E, 
              EPF_C, FPF_C, EPF_E, FPF_E,PF_ADM, DLI, DLI_ADM, (EPF_C+FPF_C+EPF_E+FPF_E+DLI+DLI_ADM) TOTAL,  PF_GROSS1 TOTAL_EARN,  
              '01/08/2020' DATEFROM,'31/08/2020' DATETO,NULL,NULL,NULL,0,0,0
              FROM (
          SELECT C.COMPANYNAME, D.DIVISIONNAME, A.CATEGORYCODE, B.CATEGORYDESC,  GROSSWAGES, PF_GROSS EPF, PF_GROSS1, PF_TMP, PF_E,PF_E EPF_C, 0 FPF_C, 
              CASE WHEN B.CATEGORYTYPE <> 'WORKER' THEN FPF1 ELSE ROUND(FPF,0) END  FPF_E , ROUND(FPF1,0)  FPF_E1 , 
              ROUND(PF_E,0) - CASE WHEN B.CATEGORYTYPE <> 'WORKER' THEN FPF1 ELSE ROUND(FPF,0) END  EPF_E,0 PF_ADM, 
              ROUND((E.DLIPER*PF_GROSS/100),0) DLI, ROUND((E.DLIPER*PF_GROSS/100),0) DLI_ADM FROM
               (
                  SELECT COMPANYCODE, DIVISIONCODE, CATEGORYCODE,  ROUND(SUM(GROSSWAGES),0) GROSSWAGES, ROUND(SUM(PF_GROSS),0) PF_GROSS,
                   ROUND(SUM(PF_GROSS1),0) PF_GROSS1, ROUND(SUM(FLOOR(PF_GROSS1)*0.0833),0) FPF1, ROUND(SUM(PF_TMP),0) PF_TMP, ROUND(SUM(PF_E),0) PF_E, 
                   SUM(ROUND(FPF,0)) FPF
                  FROM 
                  (
                      SELECT A.COMPANYCODE, A.DIVISIONCODE, A.CATEGORYCODE, NVL(A.GROSSWAGES,0) GROSSWAGES, NVL(A.PF_GROSS,0) PF_GROSS, 
                      ( 
                          CASE WHEN NVL(A.PF_GROSS,0) >=15000 THEN 15000 ELSE FLOOR(NVL(A.PF_GROSS,0)) END 
                      ) PF_GROSS1, 
                      ( 
                          CASE WHEN ROUND(A.PF_GROSS,0) >=15000 THEN (FLOOR(ROUND(A.PF_GROSS,0))-15000) ELSE 0 END 
                      ) PF_TMP, 
                      ROUND(A.PF_E,0) PF_E, ROUND(A.FPF,0) FPF,  0 PF1, 0 PF2
                      FROM ( 
                          SELECT COMPANYCODE, DIVISIONCODE , WORKERSERIAL, TOKENNO,CATEGORYCODE,  SUM(GROSSWAGES) GROSSWAGES,
                          SUM(FLOOR(PF_GROSS)) PF_GROSS, SUM(PF_E) PF_E , SUM(FLOOR(PF_GROSS)*0.0833) FPF  
                          FROM GPSPAYSHEETDETAILS
                          WHERE PERIODTO >=TO_DATE('01/08/2020','DD/MM/YYYY') 
                          AND PERIODTO <=TO_DATE('31/08/2020','DD/MM/YYYY') 
                          AND DIVISIONCODE ='0007' 
                          AND COMPANYCODE ='JT0069'
                          AND CATEGORYCODE  IN ('ST')
--                          AND CLUSTERCODE  IN ('KO')
                          AND PF_E>0 
                          GROUP BY COMPANYCODE, DIVISIONCODE,CATEGORYCODE , WORKERSERIAL, TOKENNO
                      )  A
                  ) 
                  GROUP BY COMPANYCODE, DIVISIONCODE, CATEGORYCODE
              ) A, GPSCATEGORYMAST B, COMPANYMAST C, DIVISIONMASTER D,
              (
                  SELECT TO_NUMBER(PARAMETER_VALUE) DLIPER FROM SYS_PARAMETER
                  WHERE PARAMETER_NAME ='DLIPERCENTAGE'
                  AND COMPANYCODE='JT0069'
                  AND DIVISIONCODE LIKE '%'||0007||'%'
              )E
              WHERE A.COMPANYCODE=B.COMPANYCODE
              AND A.DIVISIONCODE=B.DIVISIONCODE
              AND A.CATEGORYCODE=B.CATEGORYCODE
              AND   A.COMPANYCODE=C.COMPANYCODE
              AND   A.COMPANYCODE=D.COMPANYCODE
              AND A.DIVISIONCODE=D.DIVISIONCODE
       )

-----------------------------------------------------------------------

SELECT * FROM (
SELECT A.COMPANYCODE, A.DIVISIONCODE, A.CATEGORYCODE, NVL(A.GROSSWAGES,0) GROSSWAGES, NVL(A.PF_GROSS,0) PF_GROSS, 
( 
    CASE WHEN NVL(A.PF_GROSS,0) >=15000 THEN 15000 ELSE FLOOR(NVL(A.PF_GROSS,0)) END 
) PF_GROSS1, 
( 
    CASE WHEN ROUND(A.PF_GROSS,0) >=15000 THEN (ROUND(A.PF_GROSS,0)-15000) ELSE 0 END 
) PF_TMP, 
ROUND(A.PF_E,0) PF_E, 0 PF1, 0 PF2,  ROUND(A.FPF,0 ) FPF1, ROUND(FLOOR(NVL(A.PF_GROSS,0))*0.0833,0) FPF
FROM ( 
    SELECT COMPANYCODE, DIVISIONCODE , WORKERSERIAL, TOKENNO,CATEGORYCODE,  
    SUM(GROSSWAGES) GROSSWAGES,SUM(PF_GROSS) PF_GROSS, SUM(PF_E) PF_E
    FROM GPSPAYSHEETDETAILS
    WHERE PERIODTO >=TO_DATE('01/08/2020','DD/MM/YYYY') 
    AND PERIODTO <=TO_DATE('31/08/2020','DD/MM/YYYY') 
    AND DIVISIONCODE ='0007' 
    AND COMPANYCODE ='JT0069'
    AND CLUSTERCODE  IN ('KO')
    AND PF_E>0 
    GROUP BY COMPANYCODE, DIVISIONCODE,CATEGORYCODE , WORKERSERIAL, TOKENNO
)  A
)A
WHERE FPF<>FPF1


---------------------------------------------------------------------

INSERT INTO GTT_RPT_PFUPLOAD 

              SELECT C.COMPANYNAME, D.DIVISIONNAME, 'AUGUST-2020',B.UANNO, B.EMPLOYEENAME || ' ',FLOOR(A.GROSSWAGES) GROSSWAGES, FLOOR(A.PF_GROSS) PF_GROSS, 
              ( 
                    CASE WHEN FLOOR(A.PF_GROSS) >=15000  THEN 15000 ELSE FLOOR(A.PF_GROSS) END 
              ) PF_GROSS1, 
              ( 
                    CASE WHEN FLOOR(A.PF_GROSS) >=15000   THEN (FLOOR(A.PF_GROSS)-15000) ELSE 0 END 
              ) PF_TMP, 
              ROUND(A.PF_E,0),0 PF_E1, 0 PF1, 0 PF2,CATEGORYTYPE EX1,NULL,NULL 
             FROM ( 
                            SELECT COMPANYCODE, DIVISIONCODE,  MAX(CATEGORYTYPE) CATEGORYTYPE, WORKERSERIAL, TOKENNO,SUM(GROSSWAGES) GROSSWAGES,SUM(PF_GROSS) PF_GROSS, SUM(PF_E) PF_E
                            FROM (  
                            SELECT COMPANYCODE, DIVISIONCODE , CATEGORYTYPE, WORKERSERIAL, TOKENNO,GROSSWAGES,PF_GROSS, PF_E   
                            FROM GPSPAYSHEETDETAILS WHERE PERIODTO >=TO_DATE('01/08/2020','DD/MM/YYYY')
                            AND PERIODTO <=TO_DATE('31/08/2020','DD/MM/YYYY') 
                            AND DIVISIONCODE ='0007' 
                            AND COMPANYCODE ='JT0069' 
                            AND PF_E>0  
                            UNION ALL
                            SELECT A.COMPANYCODE, A.DIVISIONCODE ,NULL CATEGORYTYPE, A.WORKERSERIAL, B.TOKENNO,A.NETLEAVEAMOUNT GROSSWAGES, A.PFGROSS ,  A.PFAMOUNT PF_E    
                            FROM GPSLEAVEPROCALCULATION A, GPSEMPLOYEEMAST B
                            WHERE A.COMPANYCODE=B.COMPANYCODE
                            AND A.DIVISIONCODE=B.DIVISIONCODE
                            AND A.WORKERSERIAL= B.WORKERSERIAL 
                            AND A.PFDATE >=TO_DATE('01/08/2020','DD/MM/YYYY')
                            AND A.PFDATE <=TO_DATE('31/08/2020','DD/MM/YYYY') 
                            AND A.DIVISIONCODE ='0007' 
                            AND A.COMPANYCODE ='JT0069'
                            AND A.PFAMOUNT>0  
                            )
                            GROUP BY COMPANYCODE, DIVISIONCODE, WORKERSERIAL, TOKENNO
                          ) A, GPSEMPLOYEEMAST B, COMPANYMAST C, DIVISIONMASTER D 
              WHERE A.COMPANYCODE=B.COMPANYCODE 
              AND A.DIVISIONCODE=B.DIVISIONCODE 
              AND A.WORKERSERIAL=B.WORKERSERIAL 
              AND A.COMPANYCODE=C.COMPANYCODE 
              AND A.COMPANYCODE=D.COMPANYCODE 
              AND A.DIVISIONCODE=D.DIVISIONCODE 
   AND      B.CATEGORYCODE  IN ('ST')
   ORDER BY B.EMPLOYEENAME

EPF_PERCENTAGE :.0367,PF_PERCENTAGE :.12


-----------------------------------------------------------------------

INSERT INTO GTT_GPSPFREGISTER
          
          
          SELECT COMPANYNAME, DIVISIONNAME, CATEGORYCODE, CATEGORYDESC,  GROSSWAGES, EPF, PF_GROSS1, PF_TMP, PF_E, 
              EPF_C, FPF_C, EPF_E, FPF_E,PF_ADM, DLI, DLI_ADM, (EPF_C+FPF_C+EPF_E+FPF_E+DLI+DLI_ADM) TOTAL,  PF_GROSS1 TOTAL_EARN,  
              '01/08/2020' DATEFROM,'31/08/2020' DATETO,NULL,NULL,NULL,0,0,0
              FROM (
          SELECT C.COMPANYNAME, D.DIVISIONNAME, A.CATEGORYCODE, B.CATEGORYDESC,  GROSSWAGES, PF_GROSS EPF, PF_GROSS1, PF_TMP, PF_E,PF_E EPF_C, 0 FPF_C, 
              CASE WHEN B.CATEGORYTYPE <> 'WORKER' THEN FPF1 ELSE ROUND(A.FPF,0) END  FPF_E , ROUND(PF_E,0) - CASE WHEN B.CATEGORYTYPE <> 'WORKER' THEN FPF1 ELSE ROUND(A.FPF,0) END  EPF_E,0 PF_ADM, 
              ROUND((E.DLIPER*PF_GROSS/100),0) DLI, ROUND((E.DLIPER*PF_GROSS/100),0) DLI_ADM FROM
               (
                  
                  SELECT COMPANYCODE, DIVISIONCODE, CATEGORYCODE,  ROUND(SUM(GROSSWAGES),0) GROSSWAGES, ROUND(SUM(PF_GROSS),0) PF_GROSS,
                   ROUND(SUM(PF_GROSS1),0) PF_GROSS1, SUM(ROUND(PF_GROSS1*0.0833,0)) FPF1,  
                   ROUND(SUM(PF_TMP),0) PF_TMP, ROUND(SUM(PF_E),0) PF_E, ROUND(SUM(FPF),0) FPF
                  FROM 
                  (
                      SELECT A.COMPANYCODE, A.DIVISIONCODE, A.CATEGORYCODE, NVL(A.GROSSWAGES,0) GROSSWAGES, NVL(A.PF_GROSS,0) PF_GROSS, 
                      ( 
                          CASE WHEN NVL(A.PF_GROSS,0) >=15000 THEN 15000 ELSE FLOOR(NVL(A.PF_GROSS,0)) END 
                      ) PF_GROSS1, 
                      ( 
                          CASE WHEN ROUND(A.PF_GROSS,0) >=15000 THEN (ROUND(A.PF_GROSS,0)-15000) ELSE 0 END 
                      ) PF_TMP, 
                      ROUND(A.PF_E,0) PF_E, 0 PF1, 0 PF2, A.FPF
                      FROM ( 
                          SELECT COMPANYCODE, DIVISIONCODE , WORKERSERIAL, TOKENNO,CATEGORYCODE,  
                          SUM(GROSSWAGES) GROSSWAGES,SUM(PF_GROSS) PF_GROSS, SUM(PF_E) PF_E, ROUND(SUM(FLOOR(PF_GROSS)*0.0833)) FPF    
                          FROM GPSPAYSHEETDETAILS
                          WHERE PERIODTO >=TO_DATE('01/08/2020','DD/MM/YYYY') 
                          AND PERIODTO <=TO_DATE('31/08/2020','DD/MM/YYYY') 
                          AND DIVISIONCODE ='0007' 
                          AND COMPANYCODE ='JT0069'
                          AND CATEGORYCODE  IN ('ST')
                          AND PF_E>0 
                          GROUP BY COMPANYCODE, DIVISIONCODE,CATEGORYCODE , WORKERSERIAL, TOKENNO
                      )  A
                  ) 
                  GROUP BY COMPANYCODE, DIVISIONCODE, CATEGORYCODE
                  
                  
                  
              ) A, GPSCATEGORYMAST B, COMPANYMAST C, DIVISIONMASTER D,
              (
                  SELECT TO_NUMBER(PARAMETER_VALUE) DLIPER FROM SYS_PARAMETER
                  WHERE PARAMETER_NAME ='DLIPERCENTAGE'
                  AND COMPANYCODE='JT0069'
                  AND DIVISIONCODE LIKE '%'||0007||'%'
              )E
              WHERE A.COMPANYCODE=B.COMPANYCODE
              AND A.DIVISIONCODE=B.DIVISIONCODE
              AND A.CATEGORYCODE=B.CATEGORYCODE
              AND   A.COMPANYCODE=C.COMPANYCODE
              AND   A.COMPANYCODE=D.COMPANYCODE
              AND A.DIVISIONCODE=D.DIVISIONCODE
       )

