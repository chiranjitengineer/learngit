
INSERT INTO PFLOANBREAKUP
(
    COMPANYCODE, DIVISIONCODE, EMPLOYEECOMPANYCODE, EMPLOYEEDIVISIONCODE, YEARCODE, YEARMONTH, CATEGORYCODE, 
    GRADECODE, PFNO, TOKENNO, WORKERSERIAL, LOANCODE, LOANDATE, EFFECTYEARMONTH,  AMOUNT, 
    TRANSACTIONTYPE, EFFECTFORTNIGHT, PAIDON, ISPAID, REMARKS, MODULE, SYSROWID, USERNAME, LASTMODIFIED
)  
SELECT  A.COMPANYCODE, A.DIVISIONCODE, A.COMPANYCODE EMPLOYEECOMPANYCODE, A.DIVISIONCODE EMPLOYEEDIVISIONCODE, YEARCODE, YEARMONTH, CATEGORYCODE,
         GRADECODE, B.PFNO, A.TOKENNO, A.WORKERSERIAL, C.LOANCODE, C.LOANDATE,YEARMONTH EFFECTYEARMONTH, AMOUNT,
         TRANSACTIONTYPE,PAIDON EFFECTFORTNIGHT, PAIDON,'Y' ISPAID, 'BULK TRANSFER FROM PF DATA UPLOAD' REMARKS, A.MODULE,
         A.TOKENNO||'-'||TRANSACTIONTYPE||'-'||C.LOANCODE||'-'||TO_CHAR(PAIDON,'DDMMYYYY') SYSROWID, A.USERNAME, SYSDATE LASTMODIFIED
        FROM
        (   
            SELECT COMPANYCODE, DIVISIONCODE,YEARCODE, YEARMONTH, WORKERSERIAL, TOKENNO, LOAN_CAP AMOUNT,'CAPITAL' TRANSACTIONTYPE, LAST_DAY(TO_DATE(YEARMONTH,'YYYYMM')) PAIDON, MODULE,USERNAME FROM STAFFPFDATAUPLOAD WHERE  LOAN_CAP > 0
            UNION ALL
            SELECT COMPANYCODE, DIVISIONCODE,YEARCODE, YEARMONTH, WORKERSERIAL, TOKENNO, LOAN_INT AMOUNT,'INTEREST' TRANSACTIONTYPE, LAST_DAY(TO_DATE(YEARMONTH,'YYYYMM')) PAIDON, MODULE,USERNAME  FROM STAFFPFDATAUPLOAD WHERE  LOAN_INT > 0
        ) A, PFEMPLOYEEMASTER B,
        (
            SELECT COMPANYCODE, DIVISIONCODE, WORKERSERIAL, LOANCODE, MAX(LOANDATE) LOANDATE FROM PFLOANTRANSACTION PFL
            WHERE WORKERSERIAL IN (
                SELECT DISTINCT WORKERSERIAL FROM STAFFPFDATAUPLOAD
            ) 
            AND LOANDATE = 
            (
                SELECT MAX(LOANDATE) FROM PFLOANTRANSACTION
                WHERE COMPANYCODE=PFL.COMPANYCODE
                AND DIVISIONCODE=PFL.DIVISIONCODE
                AND WORKERSERIAL=PFL.WORKERSERIAL
            )
            AND LOANTYPE ='REFUNDABLE'
            GROUP BY COMPANYCODE, DIVISIONCODE,WORKERSERIAL, LOANCODE
        ) C
        WHERE A.WORKERSERIAL=B.WORKERSERIAL
        AND     A.TOKENNO=B.TOKENNO
        AND     A.COMPANYCODE=B.COMPANYCODE
        AND     A.DIVISIONCODE=B.DIVISIONCODE
        AND     A.MODULE=B.MODULE
        AND     A.WORKERSERIAL=C.WORKERSERIAL
        AND     A.COMPANYCODE=C.COMPANYCODE
        AND     A.DIVISIONCODE=C.DIVISIONCODE;